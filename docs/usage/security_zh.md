# 安全

## 节点间通信

在多节点 vLLM 部署中，所有节点之间的通信**默认不安全**，必须通过将节点置于隔离网络中来保护。这包括：

1. PyTorch 分布式通信
2. KV 缓存传输通信
3. 张量、流水线和数据并行通信

### 节点间通信的配置选项

以下选项控制 vLLM 中的节点间通信：

#### 1. **环境变量：**
   - `VLLM_HOST_IP`：设置 vLLM 进程用于通信的 IP 地址

#### 2. **KV 缓存传输配置：**
   - `--kv-ip`：KV 缓存传输通信的 IP 地址（默认：127.0.0.1）
   - `--kv-port`：KV 缓存传输通信的端口（默认：14579）

#### 3. **数据并行配置：**
   - `data_parallel_master_ip`：数据并行主节点的 IP 地址（默认：127.0.0.1）
   - `data_parallel_master_port`：数据并行主节点的端口（默认：29500）

### 关于 PyTorch 分布式的说明

vLLM 使用 PyTorch 的分布式功能进行部分节点间通信。有关 PyTorch 分布式安全注意事项的详细信息，请参阅 [PyTorch 安全指南](https://github.com/pytorch/pytorch/security/policy#using-distributed-features)。

PyTorch 安全指南的要点：
- PyTorch 分布式功能仅用于内部通信
- 它们不适合在不受信任的环境或网络中使用
- 出于性能原因，未包含授权协议
- 消息以未加密方式发送
- 连接不经检查即可从任何地方接受

### 安全建议

#### 1. **网络隔离：**
   - 在专用隔离网络上部署 vLLM 节点
   - 使用网络分段防止未经授权的访问
   - 实施适当的防火墙规则

#### 2. **配置最佳实践：**
   - 始终将 `VLLM_HOST_IP` 设置为特定 IP 地址，而不是使用默认值
   - 配置防火墙，仅允许节点间必要的端口通信

#### 3. **访问控制：**
   - 限制对部署环境的物理和网络访问
   - 对管理接口实施适当的身份验证和授权
   - 对所有系统组件遵循最小权限原则

## 安全与防火墙：保护暴露的 vLLM 系统

虽然 vLLM 设计上允许将不安全的网络服务隔离到私有网络，但某些组件（如依赖项和底层框架）可能会在所有网络接口上开启不安全的服务，有时这超出了 vLLM 的直接控制范围。

一个主要问题是使用 `torch.distributed`，vLLM 利用它进行分布式通信，包括在单主机上使用 vLLM 时。当 vLLM 使用 TCP 初始化（参见 [PyTorch TCP 初始化文档](https://docs.pytorch.org/docs/stable/distributed.html#tcp-initialization)）时，PyTorch 会创建一个 `TCPStore`，默认情况下该存储监听所有网络接口。这意味着，除非采取额外的保护措施，否则这些服务可能被任何能够通过任何网络接口访问您的主机的设备访问。

**从 PyTorch 的角度来看，任何使用 `torch.distributed` 的行为默认应视为不安全。** 这是 PyTorch 团队已知且有意为之的行为。

### 防火墙配置指南

保护 vLLM 系统的最佳方法是仔细配置防火墙，仅暴露必要的最小网络表面。在大多数情况下，这意味着：

- **阻止所有传入连接，除了 API 服务器监听的 TCP 端口。**

- 确保用于内部通信的端口（如 `torch.distributed` 和 KV 缓存传输使用的端口）仅对受信任的主机或网络开放。

- 切勿将这些内部端口暴露给公共互联网或不受信任的网络。

请参阅您的操作系统或应用程序平台文档以获取具体的防火墙配置说明。

## 报告安全漏洞

如果您认为在 vLLM 中发现了安全漏洞，请按照项目的安全策略进行报告。有关如何报告安全问题以及项目安全策略的更多信息，请参阅 [vLLM 安全策略](https://github.com/vllm-project/vllm/blob/main/SECURITY.md)。